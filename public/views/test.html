<!DOCTYPE html>
<html xmlns="https://www.w3.org/1999/xhtml" ng-app="syncApp">
	<head>
		<title>Ng Template</title>
		<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" charset="utf-8"  />
		<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" />
		<link href="//cdn.syncfusion.com/18.2.0.44/js/web/flat-azure/ej.web.all.min.css" rel="stylesheet" />
	  
		<script src="//cdn.syncfusion.com/js/assets/external/jquery-1.11.3.min.js" type="text/javascript"></script>
		<script src="//cdn.syncfusion.com/js/assets/external/jquery.easing.1.3.min.js" type="text/javascript"></script>
		<script src="//cdn.syncfusion.com/js/assets/external/angular.min.js" type="text/javascript"></script>
		<script src="//cdn.syncfusion.com/18.2.0.44/js/web/ej.web.all.min.js" type="text/javascript"></script>    
		<script src="//cdn.syncfusion.com/18.2.0.44/js/common/ej.widget.angular.min.js" type="text/javascript"></script>
		<script src="//cdn.syncfusion.com/js/assets/external/jsrender.min.js"></script>
		<!-- Bootstrap Themes Start -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
		<!-- Bootstrap Themes End -->
		<!-- Alertify CDN Starts -->
		<script src="//cdn.jsdelivr.net/npm/alertifyjs@1.11.2/build/alertify.min.js"></script>
		<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/alertifyjs@1.11.2/build/css/alertify.min.css"/>
		<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/alertifyjs@1.11.2/build/css/themes/default.min.css"/>
		<!-- Alertify CDN Ends -->

	</head>
	<body ng-controller="diagramCtrl" ng-init="init();">
		<script src="//borismoore.github.io/jsrender/jsrender.min.js"></script>
		
		<div class="col-sm-4">
			<button id="add" 		class="btn btn-primary" ng-click="ConnectorAdd();">Add Connector</button>&nbsp;
			<button id="addNode" 	class="btn btn-primary" ng-click="NodeAdd();">Add Event</button>&nbsp;
			<button id="values" 	class="btn btn-success" ng-click="submitEvents();">Submit</button>&nbsp;
			<button id="export" 	class="btn btn-default" ng-click="ExportDiagram();" style="display:none;">Submit</button>&nbsp;
		</div>
	
		<script ng-model="select" id="htmlTemplate" type="text/ng-template">
			<div style="margin-top:15%;"> 
				<select  ng-model="$parent.diagram.model.drawType.value.select" class="form-control" ng-chanhe="$parent.SelectField();">
					<option class="dropdown-item" value="Option 1" selected> Choose Options</option>
					<option class="dropdown-item" value="comissioning"> Comissioning 	</option>
					<option class="dropdown-item" value="shipping"> 	Shipping 		</option>
					<option class="dropdown-item" value="receiving"> 	Receiving 		</option>
				</select>
				<br/>
				<input ng-model="$parent.diagram.model.drawType.value.text" ng-blur="$parent.change();"  class="form-control" autocomplete="off" type="text" placeholder="number of objects"></input>         
			</div>
		</script>
		
		<ej-diagram id="diagram" e-height="600px" e-width="100%" e-nodeCollectionChange="collectionChange" e-connectorCollectionChange="connectorCollectionChange" e-connectorTargetChange="connectorTargetChange" e-connectorSourceChange="connectorSourceChange"></ej-diagram>
		
		<script>
			var syncApp 			= 	angular.module("syncApp", ["ejangular"]);
			var nodeCounter			=	1;			
			
			syncApp.controller('diagramCtrl', function ($scope,$http)
			{ 

				$scope.NodeAdd	=	function()
				{
					$scope.hello			=	'DRAWING NODE';
					$scope.diagram 			=  	angular.element("#diagram").ejDiagram("instance");
					var ports 				= 	[{name:"port1",offset:{x:0,y: 0.5},shape: "circle"},{name:"port2",offset:{x: 1,y: 0.5},shape: "circle"},{name:"port3",offset:{x:0.5,y:0},shape: "circle"},{name:"port4",offset:{x:0.5,y:1},shape: "circle"}];
					var name				=	"Event"+nodeCounter;
					var label				=	[{text:name ,offset:{x: 0.5,y: 0.1 }}];
					$scope.diagram .model.drawType 	= 	{ 
													type		: 	"html", 
													name 		:	name,
													templateId	: 	"htmlTemplate",
													labels		:	label,
													ports		:	ports,
													value		:	{
																		text	:	"text"+Number(nodeCounter),
																		select	:	"BusinessStep"+Number(nodeCounter)
																	}
												};
					var tool 				= $scope.diagram.tool();
					$scope.diagram.update({ tool: tool | ej.datavisualization.Diagram.Tool.DrawOnce });
					nodeCounter++;
				}
				
				
				$scope.change	=	function(){
					console.log('TEXT CHANGE');
					var diagram 		= 	angular.element("#diagram").ejDiagram("instance"); 
					var node 			= 	diagram.selectionList[0];
					var text 			= 	diagram.model.drawType.value.text; 
					node.addInfo.value 	= 	text;
					console.log(node);
				}
				
				
				//on change of the Select fied get the values and populate in Node addinfo
				$scope.SelectField		=	function(){
					console.log('Within Select Change');
					var diagram 		= 	angular.element("#diagram").ejDiagram("instance"); 
					var node 			= 	diagram.selectionList[0];
					var select 			= 	diagram.model.drawType.value.select; 
					node.addInfo.value 	= 	select;
					console.log(node);
				}
				
				//Get value from db to populate the select field within the Each Node
				$scope.init 	=	function () {
					$http({
					url: "/populateFields",
					method: "GET"
					}).success(function(response) {
					$scope.businessSteps 		=	response.businessStep;
					businessSteps				=	$scope.businessSteps;

					}).error(function(error) {
					console.log(error);
					});
				}

			});
		</script>


		
    </body>
    </html>